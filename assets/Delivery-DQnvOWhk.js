import{c as F,r as l,s as W,i as C,e as ee,p as te,f as $,g as re,h as se,b as ae,k as D,I as V,l as J,j as e,B as ie,S as ne,m as le,D as oe,P as ce,R as de,X as ue,O as pe,v as w,n as me,z as g,o as he,q as xe}from"./index-DeDTw6N8.js";import{u as fe,P as ge,C as ye}from"./useOrder-C51UsExc.js";import{M as be}from"./map-pin-Ct7zDaWF.js";const ve=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],M=F("chevron-right",ve);const je=[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]],we=F("credit-card",je),N=[{id:1,title:"Shipping",icon:be},{id:2,title:"Delivery",icon:ge},{id:3,title:"Payment",icon:we},{id:4,title:"Confirm",icon:ye}],Ne=()=>{try{const s=localStorage.getItem("currentUserId")||null;return s&&JSON.parse(localStorage.getItem(`delivery_${s}`))?.currentStep||1}catch(s){return console.log(s.message),1}},Ie=()=>{try{const s=localStorage.getItem("currentUserId")||null;return s&&JSON.parse(localStorage.getItem(`delivery_${s}`))?.pendingOrderId||null}catch(s){return console.log(s.message),null}};function $e(){const s=l.useRef(null),i=l.useRef(Ie()),[r,y]=l.useState(Ne),[Z,_]=l.useState(!1),[n,b]=l.useReducer(W,C,ee),[o,v]=l.useReducer(te,$,re),{cart:u,totalValue:p,totalCount:E,selectedDeliveryTariff:I,removeItem:U,incQty:B,decQty:H,selectDeliveryTariff:G,resetCart:L}=se(),{initOrders:S,createOrder:P,updateOrderStatus:q,startDeliveryTimer:Q,cancelOrder:z}=fe(),{currentUserId:a}=ae(),h=parseFloat((p*.05).toFixed(2)),A=me<=p,m=A?0:D[I??"Eco"].price,T={name:/^[A-ZА-ЯЁ][a-zа-яё]+$/.test(n.name),lastName:/^[A-ZА-ЯЁ][a-zа-яё]+$/.test(n.lastName),address:n.address.length>=10,city:/^[A-ZА-ЯЁ][a-zа-яё]+(?:[\s-][A-ZА-ЯЁ][a-zа-яё]+)*$/.test(n.city),state:/^[A-ZА-ЯЁ][a-zа-яё]+(?:[\s-][A-ZА-ЯЁ][a-zа-яё]+)*$/.test(n.state),zip:/^\d{5}(-\d{4})?$/.test(n.zip),phone:/^\+[1-9]\(\d{3}\)\d{3}-\d{4}$/.test(n.phone)},j=Object.values(T).every(t=>t===!0),R={cardNumber:/^\d{4} \d{4} \d{4} \d{4}$/.test(o.cardNumber),expiryDate:/^(0[1-9]|1[0-2])\/\d{2}$/.test(o.expiryDate),cvv:/^\d{3}$/.test(o.cvv),cardHolder:/^[A-ZА-ЯЁ][a-zа-яё]+ [A-ZА-ЯЁ][a-zа-яё]+$/.test(o.cardHolder)},k=Object.values(R).every(t=>t===!0),Y=t=>t<=r?!0:!(t===2&&!j||t===3&&!j||t===4&&(!j||!k)),O=t=>{if(!Y(t)){g.error("Please fill in fields correctly!");return}if(Object.values(u).length===0){g.error("Please add items to cart!");return}y(t),g.success("Success!")},X=()=>{b({type:he}),v({type:xe}),L()},K=async()=>{_(!0),s.current?.abort(),s.current=new AbortController;const t=s.current.signal;try{await g.promise(new Promise((c,d)=>{const f=setTimeout(()=>{c(!0)},2e3);if(t){if(t.aborted){clearTimeout(f),d(new DOMException("Aborted","AbortError"));return}t.addEventListener("abort",()=>{clearTimeout(f),d(new DOMException("Aborted","AbortError"))},{once:!0})}}),{loading:"Placing your order...",success:"Order placed successfully!"}),q(i.current,"shipped"),Q(i.current),localStorage.removeItem(`delivery_${a}`),X(),y(1),i.current=null}catch(c){c.name==="AbortError"?g.success("Order cancelled"):console.log(c.message)}finally{_(!1),s.current=null}},x=l.useCallback(()=>{s.current?.abort(),s.current=null},[]);return l.useEffect(()=>{if(r!==3&&r!==4||i.current)return;const t=P({date:new Date().toString().split(" GMT")[0],cartItems:u,totalValue:p+h+m,taxValue:h,deliveryValue:m,totalCount:E,status:"processing"});i.current=t,localStorage.setItem(`delivery_${a}`,JSON.stringify({shippingData:n,paymentInfoData:o,currentStep:r,pendingOrderId:t}))},[p,h,m,E,u,P,r,a,n,o]),l.useEffect(()=>{if(a){const t=JSON.parse(localStorage.getItem(`delivery_${a}`))||{},c=JSON.parse(localStorage.getItem(`orders_${a}`))||{orders:{}};b({type:V,payload:t?.shippingData||C}),v({type:J,payload:t?.paymentInfoData||$}),y(t?.currentStep||1),S(c.orders||{});const d=t?.pendingOrderId;d&&c.orders?.[d]?.status==="processing"?i.current=d:i.current=null}else b({type:V,payload:C}),v({type:J,payload:$}),y(1),S({}),i.current=null},[a,S]),l.useEffect(()=>{a&&localStorage.setItem(`delivery_${a}`,JSON.stringify({shippingData:n,paymentInfoData:o,currentStep:r,pendingOrderId:i.current}))},[r,a,n,o]),l.useEffect(()=>{if(r<=2&&i.current){x(),z(i.current);const t=JSON.parse(localStorage.getItem(`delivery_${a}`))||{},c=JSON.parse(localStorage.getItem(`orders_${a}`))||{orders:{}},d={...t},f={...c};delete d.pendingOrderId,delete f.orders[i.current],localStorage.setItem(`delivery_${a}`,JSON.stringify(d)),localStorage.setItem(`orders_${a}`,JSON.stringify(f)),i.current=null}},[r,x,z,a]),l.useEffect(()=>()=>x(),[x]),e.jsx("section",{className:"container w-full text-white sm:px-6",children:e.jsxs("div",{className:"flex flex-col mt-[2rem]",children:[e.jsx(ie,{}),e.jsxs("div",{className:"container w-full py-8",children:[e.jsx("div",{className:"max-w-4xl mx-auto mb-12",children:e.jsxs("div",{className:"flex items-center justify-between relative",children:[e.jsx("div",{className:"absolute left-0 right-0 top-1/2 h-0.5 -translate-y-1/2 bg-gradient-to-r from-white/10 via-white/10 to-white/10"}),e.jsx("div",{className:"absolute left-0 top-1/2 h-0.5 -translate-y-1/2 bg-gradient-to-r from-violet-500 via-purple-500 to-fuchsia-500 transition-all duration-500",style:{width:`${(r-1)/(N.length-1)*100}%`}}),N.map(t=>e.jsx(ne,{step:t,currentStep:r,handleContinueButton:O},t.id))]})}),e.jsx("div",{className:"max-w-5xl mx-auto",children:e.jsxs("div",{className:"grid gap-6 lg:grid-cols-[1fr_400px]",children:[e.jsxs("div",{className:"rounded-3xl border border-white/10 bg-gradient-to-br from-zinc-900/80 via-purple-900/10 to-zinc-900/80 p-8 backdrop-blur",children:[r===1&&e.jsx(le,{formData:n,dispatch:b,validation:T}),r===2&&e.jsx(oe,{tariffs:D,selectedDeliveryTariff:I,selectDeliveryTariff:G}),r===3&&e.jsx(ce,{formData:o,dispatch:v,validation:R}),r===4&&e.jsx(de,{allDeliveryInfo:{shippingData:n,paymentInfoData:o,tariff:D[I]}}),e.jsxs("div",{className:"flex items-center justify-between mt-8 pt-6 border-t border-white/10",children:[e.jsx("button",{onClick:()=>O(Math.max(1,r-1)),disabled:r===1,className:"px-6 cursor-pointer py-3 rounded-xl border border-white/10 bg-white/5 text-white disabled:opacity-30 disabled:cursor-not-allowed hover:bg-white/10 transition-colors",children:"Back"}),r!==N.length?e.jsxs("button",{className:`px-6 inline-flex justify-center items-center gap-2 cursor-pointer py-3 rounded-xl border border-white/10 bg-white/5 text-white hover:bg-white/10 transition-colors disabled:opacity-30 disabled:cursor-not-allowed
                                                ${r===1&&!j||r===3&&!k?"opacity-50 not-allowed":""}
                                            `,onClick:()=>O(Math.min(N.length,r+1)),children:["Continue",e.jsx(M,{className:"h-4 w-4"})]}):Z?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{className:"px-6 inline-flex justify-center items-center gap-2 cursor-pointer py-3 rounded-xl border border-white/10 bg-white/5 text-white hover:bg-white/10 transition-colors",children:[e.jsx("div",{className:"opacity-50 w-5 h-5 border-4 border-white/30 border-t-white rounded-full animate-spin"}),"Placing..."]}),e.jsx("button",{className:"px-6 inline-flex justify-center items-center gap-2 cursor-pointer py-3 rounded-xl border border-white/10 bg-white/5 text-white hover:bg-white/10 transition-colors",onClick:x,children:e.jsx(ue,{})})]})}):e.jsxs("button",{className:"px-6 inline-flex justify-center items-center gap-2 cursor-pointer py-3 rounded-xl border border-white/10 bg-white/5 text-white hover:bg-white/10 transition-colors",onClick:K,children:["Place Order",e.jsx(M,{className:"h-4 w-4"})]})]})]}),e.jsxs("div",{className:"rounded-3xl border border-white/10 bg-gradient-to-br from-zinc-900/60 via-purple-900/20 to-zinc-900/60 p-6 backdrop-blur h-fit sticky top-24",children:[e.jsx("h3",{className:"text-xl font-semibold mb-4",children:"Order Summary"}),e.jsxs("div",{className:"max-h-[25rem] overflow-y-auto scrollbar-reviews custom-scroll",children:[Object.values(u).map(t=>e.jsx(pe,{item:t,removeItem:U,incQty:B,decQty:H,currentStep:r},t.id)),Object.values(u).length===0&&e.jsx("p",{className:"text-gray-400 text-center py-8",children:"Your cart is empty."})]}),e.jsxs("div",{className:"space-y-2 py-4 border-t border-b border-white/10",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Subtotal"}),e.jsxs("span",{className:"inline-flex text-white justify-center items-center gap-1",children:[p,e.jsx("img",{src:w,alt:"Value Icon",className:"w-4 h-4"})]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Shipping"}),e.jsxs("span",{className:"inline-flex text-white justify-center items-center gap-1",children:[m?`at least ${m}`:"Free",e.jsx("img",{src:w,alt:"Value Icon",className:"w-4 h-4"})]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-400",children:"Tax"}),e.jsxs("span",{className:"inline-flex justify-center items-center gap-1 text-white",children:[h,e.jsx("img",{src:w,alt:"Value Icon",className:"w-4 h-4"})]})]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-4",children:[e.jsx("span",{className:"text-2xl font-semibold",children:"Total"}),e.jsxs("span",{className:"text-2xl font-semibold inline-flex text-white justify-center items-center gap-1",children:[Object.values(u).length===0?0:p+h+(A?0:m),e.jsx("img",{src:w,alt:"Value Icon",className:"w-6 h-6"})]})]})]})]})})]})]})})}export{$e as default};
